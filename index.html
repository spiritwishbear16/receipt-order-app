<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI æ™ºèƒ½è¨‚å–®æ”¶æ“š</title>

<style>
/* ===========================
   ä½ çš„åŸç‰ˆæ¨£å¼ï¼ˆå®Œå…¨ä¿ç•™ï¼‰
   =========================== */
body {
    margin: 0;
    padding: 0;
    background-color: #444;
    font-family: 'Roboto Mono','Noto Sans TC', monospace;
    display: flex;
    justify-content: center;
    min-height: 100vh;
}
.receipt {
    background-color: #fff;
    width: 100%;
    max-width: 375px;
    padding: 20px 15px 40px 15px;
    box-sizing: border-box;
    font-size: 13px;
    line-height: 1.4;
    color: #000;
    box-shadow: 0 0 20px rgba(0,0,0,0.5);
}
[contenteditable="true"] {
    outline: none;
    border-bottom: 1px dotted transparent;
}
.capture-mode [contenteditable="true"]:focus {
    background-color: #fff !important;
    border-bottom: 1px dotted transparent !important;
}
.header { text-align: center; margin-bottom: 8px; }
.title { font-size: 22px; font-weight: 700; letter-spacing: 2px; }
.row { display: flex; justify-content: space-between; align-items: flex-start; }
.bold { font-weight: 700; }
.center { text-align: center; }
.right { text-align: right; }
.divider-solid { border-bottom: 1.5px solid #000; margin: 6px 0; }
.divider-dashed { border-bottom: 1px dashed #000; margin: 6px 0; }
.store-name { font-size: 20px; font-weight: 700; text-align: center; margin: 10px 0 5px 0; }
.item-block { margin-bottom: 6px; }
.item-name { display: block; margin-bottom: 2px; }

.dynamic-item-wrapper {
    position: relative;
    padding-left: 30px;
    min-height: 25px;
}
.delete-btn {
    position: absolute;
    left: 0;
    top: 0;
    font-size: 18px;
    cursor: pointer;
    background: #f7f7f7;
    border-radius: 50%;
    width: 25px;
    height: 25px;
    text-align: center;
    line-height: 25px;
    user-select: none;
}

.total-section { margin-top: 10px; }
.total-row {
    display: flex;
    justify-content: space-between;
    font-size: 15px;
    font-weight: 700;
    margin: 3px 0;
}
.footer { font-size: 11px; margin-top: 10px; line-height: 1.5; }

.capture-mode .delete-btn,
.capture-mode .add-btn-container,
.capture-mode .screenshot-btn,
.capture-mode .ai-btn {
    display: none!important;
}

.screenshot-btn, .ai-btn {
    position: fixed;
    right: 20px;
    background-color: #007bff;
    color: white;
    padding: 12px 18px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    z-index: 1000;
    cursor: pointer;
    font-family: 'Noto Sans TC', sans-serif;
}
.ai-btn {
    bottom: 70px;
    background: #28a745;
}
.screenshot-btn { bottom: 20px; }

/* è¡¨æ ¼æ¨£å¼ï¼ˆç°¡æ½”é¡¯ç¤ºï¼‰ */
.item-row {
    display: flex;
    justify-content: space-between;
    gap: 8px;
    align-items: center;
    font-size: 13px;
    padding: 6px 0;
}
.item-row .name { flex: 1 1 auto; min-width: 90px; }
.item-row .price, .item-row .qty, .item-row .subtotal { width: 65px; text-align: right; }
.item-row .meta { font-size: 11px; color: #666; }
.no-items { text-align: center; color: #888; padding: 8px 0; font-size: 13px; }
</style>
</head>

<body>

<div class="receipt">
    <div class="header">
        <span class="title">è¨‚ å–® æ”¶ æ“š</span> <span style="font-size:12px;">(å®¢æˆ¶è¯)</span>
    </div>

    <div class="row">
        <span id="order-no" contenteditable="true">0001-æ–°é–‹</span>
        <div class="right">
            <span class="bold" style="font-size:16px;" id="receiver" contenteditable="true">æ”¶ä»¶äººå§“å</span> è²´ä¸‹<br>
            <span style="font-size:11px;" id="current-datetime"></span>
        </div>
    </div>

    <div class="divider-solid"></div>

    <div class="store-name" contenteditable="true">ç’¦åŠç«¥è£</div>
    <div class="center" style="font-size:11px;" contenteditable="true">
        çµ±ä¸€ç·¨è™Ÿï¼š 95294390<br>
        é›»å­ä¿¡ç®±ï¼šaifangkids@gmail.com
    </div>

    <div class="divider-solid"></div>

    <div class="row bold" style="font-size:15px;">
        <span id="short-date"></span>
        <span id="top-total" contenteditable="true">TWD 0</span>
        <span>æœªçµå¸³</span>
    </div>

    <div class="divider-solid"></div>

    <div class="row" style="font-size:12px;">
        <span>å“å</span>
        <span>å–®åƒ¹ &nbsp; æ•¸é‡ &nbsp; å°è¨ˆ</span>
    </div>

    <div class="divider-solid"></div>

    <div id="item-list">
        <div class="no-items" id="no-items">ç›®å‰å°šç„¡å•†å“ï¼Œè«‹ä½¿ç”¨ã€ŒğŸ› ä¸€éµè²¼ä¸Šå•†å“ã€æˆ–æ‰‹å‹•æ–°å¢ã€‚</div>
    </div>

    <div class="divider-solid"></div>

    <div class="row" id="summary-row">
        <span>--- éŠ·å”®å°è¨ˆ ---</span>
        <span id="summary">0ç­† &nbsp; 0 &nbsp; 0</span>
    </div>

    <div class="divider-solid"></div>

    <div class="total-section">
        <div class="total-row">
            <span>å•† å“ é‡‘ é¡:</span><span id="product-total" contenteditable="true">0</span>
        </div>
        
        <div class="total-row" style="color:#d9534f;"> 
            <span>å„ª æƒ  æŠ˜ æ‰£:</span><span id="discount" contenteditable="true">0</span>
        </div>
        
        <div class="total-row">
            <span>å–® ç­† é‹ è²»:</span><span id="shipping" contenteditable="true">60</span>
        </div>

        <div class="divider-dashed"></div> 
        
        <div class="total-row" style="font-size:18px;">
            <span>æ‡‰ ä»˜ é‡‘ é¡:</span><span id="final-total" contenteditable="true">0</span>
        </div>
    </div>

    <div class="divider-solid"></div>

    <div class="footer" contenteditable="true">
        ==========================<br>
        â€»åŒ¯æ¬¾è³‡è¨Š<br>
        éŠ€è¡Œä»£ç¢¼: 103<br>
        éŠ€è¡Œåç¨±: è‡ºç£æ–°å…‰å•†æ¥­éŠ€è¡Œ - æ–—å…­åˆ†è¡Œ<br>
        å¸³è™Ÿ: [è«‹å¡«å¯«æ‚¨çš„å¸³è™Ÿ]<br>
        æˆ¶å: [è«‹å¡«å¯«æ‚¨çš„æˆ¶å/å•†è™Ÿåç¨±]<br><br>
        *ä¸Šè¿°é‡‘é¡å·²å«ç‡Ÿæ¥­ç¨…<br>
        *å–è²¨æ™‚è«‹å‹™å¿…æ”œå¸¶èˆ‡æ”¶è²¨äººå§“åç›¸åŒçš„è­‰ä»¶<br>
        *ä¸ƒå¤©é‘‘è³æœŸ<br>
    </div>
</div>

<!-- AI ä¸€éµè²¼ä¸Š -->
<button class="ai-btn" onclick="aiInput()">ğŸ› ä¸€éµè²¼ä¸Šå•†å“</button>

<!-- æˆªåœ–æ¨¡å¼ -->
<button class="screenshot-btn" onclick="toggleCaptureMode(this)">åˆ‡æ›æˆªåœ–æ¨¡å¼</button>

<script>
/* ==========================
   è‡ªå‹•æ›´æ–°æ—¥æœŸæ™‚é–“
   ========================== */
function updateDateTime() {
    const now = new Date();
    const y = now.getFullYear();
    const M = String(now.getMonth() + 1).padStart(2,"0");
    const d = String(now.getDate()).padStart(2,"0");
    const days = ["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"];
    const today = `${y}-${M}-${d}(${days[now.getDay()]})`;

    const hh = String(now.getHours()).padStart(2,"0");
    const mm = String(now.getMinutes()).padStart(2,"0");
    const ss = String(now.getSeconds()).padStart(2,"0");

    document.getElementById("current-datetime").textContent = `${today} ${hh}:${mm}:${ss}`;
    document.getElementById("short-date").textContent = `${String(y).slice(-2)}-${M}-${d}(${days[now.getDay()]})`;
}
setInterval(updateDateTime, 1000);
updateDateTime();

/* ==========================
   å…¨åŸŸå•†å“é™£åˆ—ï¼ˆå­˜ç›®å‰ç•«é¢å•†å“ï¼‰
   ========================== */
window.items = []; // {id, code, name, color, size, price, qty, subtotal}

/* ==========================
   AI ä¸€éµè²¼ä¸Šè§£æ
   ä½¿ç”¨è€…é¸æ“‡ï¼šç¯„ä¾‹å¤šè¡Œæ ¼å¼ï¼ˆä½ é¸ 1ï¼‰
   æŠ“é‡‘é¡ç›´æ¥ä½¿ç”¨æ–‡å­—å…§çš„é‡‘é¡ï¼ˆä½ é¸ 2ï¼‰
   é¡¯ç¤ºæœ€ç°¡æ½”ï¼šå“å / å–®åƒ¹ / æ•¸é‡ / å°è¨ˆï¼ˆä½ é¸ 3ï¼‰
   ========================== */
window.aiInput = function() {
    let text = prompt("è²¼ä¸Šå®¢æˆ¶è¨‚å–®å…§å®¹ï¼ˆå¤šç­†ç”¨ç©ºç™½è¡Œåˆ†éš”ï¼‰ï¼š");
    if (!text) return;
    parseMultiItem(text);
};

/* ==========================
   å¤šç­†è§£æï¼šä»¥ç©ºç™½è¡Œåˆ†æ®µ
   ========================== */
function parseMultiItem(text) {
    // å°‡ CRLF çµ±ä¸€ç‚º \n
    text = text.replace(/\r\n/g, "\n").trim();
    // ä»¥å…©å€‹ä»¥ä¸Šæ›è¡Œæˆ–ç©ºç™½è¡Œä½œç‚ºåˆ†æ®µ
    let blocks = text.split(/\n\s*\n/).map(b => b.trim()).filter(Boolean);

    blocks.forEach(b => {
        addOneItemAI(b);
    });

    updateTotals();
    alert("å·²åŠ å…¥å…¨éƒ¨å•†å“ï¼");
}

/* ==========================
   è§£æå–®ç­†å•†å“ï¼ˆæ”¯æ´ä½ çµ¦çš„ç¯„ä¾‹æ ¼å¼ï¼‰
   ç¯„ä¾‹æ ¼å¼ï¼š
   Code #A123 åœ“é ˜ä¸Šè¡£
   é¡è‰²ã€ç°è‰²ã€‘
   å°ºå¯¸ã€JMã€‘
   é‡‘é¡ï¼š290
   æ•¸é‡ï¼š2
   ========================== */
function addOneItemAI(text) {
    // ç§»é™¤å¤šé¤˜ç¬¦è™Ÿ
    text = text.replace(/âœ”ï¸/g, "").trim();

    // å…ˆé€è¡Œåˆ‡åˆ†
    const lines = text.split(/\n/).map(l => l.trim()).filter(Boolean);

    // code: å¾åŒ…å« Code æˆ– # é–‹é ­çš„è¡Œæ‰¾
    let code = "";
    for (let ln of lines) {
        let m = ln.match(/#([A-Za-z0-9\-]+)/);
        if (m) { code = m[1]; break; }
        m = ln.match(/\bCode[:#\s]*([A-Za-z0-9\-]+)/i);
        if (m) { code = m[1]; break; }
    }

    // price: æ‰¾ "é‡‘é¡" æˆ– è¡Œå…§å¸¶æ•¸å­—çš„ pattern
    let price = null;
    for (let ln of lines) {
        let m = ln.match(/é‡‘é¡[:ï¼š]?\s*([0-9]+(?:[\.,][0-9]+)?)/);
        if (m) { price = Number(m[1].replace(",", "").replace("ï¼Œ","")); break; }
        // æˆ–è€…åƒ "290x2" / "290Ã—2" / "290 å…ƒ"
        m = ln.match(/([0-9]+(?:[\.,][0-9]+)?)\s*(?:å…ƒ|TWD)?\s*(?:Ã—|x|X)?\s*([0-9]+)?/);
        if (m && ln.match(/[0-9]+/)) {
            // åªåœ¨è©²è¡Œæ²’æœ‰ä¸­æ–‡å­—ï¼ˆæˆ–åŒ…å«å…ƒ/Ã—ï¼‰æ™‚ç•¶ä½œ fallback
            if (!ln.match(/[^\d\s\.\,å…ƒTWDxXÃ—]/) || ln.includes("å…ƒ") || ln.includes("Ã—") || ln.includes("x")) {
                price = Number(m[1].replace(",", ""));
                // ä¸ç›´æ¥å– qtyï¼Œqty ç”±æ•¸é‡æ¬„ä½å…ˆæ‰¾
                break;
            }
        }
    }

    // qty: æ‰¾ "æ•¸é‡" æˆ–è¡Œå°¾ Ã— æ•¸å­—
    let qty = null;
    for (let ln of lines) {
        let m = ln.match(/æ•¸é‡[:ï¼š]?\s*([0-9]+)/);
        if (m) { qty = Number(m[1]); break; }
        m = ln.match(/(?:Ã—|x|X)\s*([0-9]+)/);
        if (m) { qty = Number(m[1]); break; }
    }

    // name: å¾ç¬¬ä¸€è¡Œå»æ‰ Code/ç·¨è™Ÿå¾Œçš„å‰©é¤˜æ–‡å­—ï¼Œæˆ–æ‰¾ç¬¬ä¸€å€‹ä¸å«é‡‘é¡/é¡è‰²/å°ºå¯¸/æ•¸é‡ çš„è¡Œ
    let name = "";
    // å˜—è©¦ç¬¬ä¸€è¡Œ
    if (lines.length > 0) {
        let first = lines[0];
        // å¦‚æœç¬¬ä¸€è¡ŒåŒ…å« Codeï¼Œå»æ‰ Code éƒ¨åˆ†
        first = first.replace(/\bCode[:#\s]*[A-Za-z0-9\-]+/i, "").trim();
        first = first.replace(/#([A-Za-z0-9\-]+)/, "").trim();
        // å¦‚æœé€™è¡Œå‰©ä¸‹çœ‹èµ·ä¾†åƒæ˜¯åç¨±ï¼ˆå«ä¸­æ–‡å­—æˆ–è‹±æ–‡å­—ï¼‰
        if (first && first.match(/[^\d\:\s]+/)) {
            name = first;
        }
    }
    // è‹¥ name é‚„æ²’å–åˆ°ï¼Œæ‰¾å…¶ä»–å¯èƒ½è¡Œ
    if (!name) {
        for (let ln of lines) {
            if (/é‡‘é¡|æ•¸é‡|é¡è‰²|å°ºå¯¸|Code|#/i.test(ln)) continue;
            // éæ¿¾ç´”æ•¸å­—è¡Œ
            if (!ln.match(/^[\d\.\,\sÃ—xXå…ƒTWD-]+$/)) {
                name = ln;
                break;
            }
        }
    }

    // é¡è‰² / å°ºå¯¸ï¼ˆéå¿…è¦ï¼‰
    let color = (text.match(/é¡è‰²[ï¼š:\s]*[ã€\[]?(.*?)[ã€‘\]]?(?:\s|$)/) || ["",""])[1].trim();
    let size = (text.match(/å°ºå¯¸[ï¼š:\s]*[ã€\[]?(.*?)[ã€‘\]]?(?:\s|$)/) || ["",""])[1].trim();

    // fallback defaults
    if (!price) price = 0;
    if (!qty) qty = 1;
    if (!name) name = code ? code : "å•†å“";

    // è¨ˆç®—å°è¨ˆï¼ˆæ­¤è™•ä¾ä½ é¸æ“‡ï¼šä½¿ç”¨æ–‡å­—å…§çš„é‡‘é¡ç›´æ¥æŠ“å–ï¼‰
    let subtotal = Number(price) * Number(qty);

    // å»ºç«‹ item ç‰©ä»¶ä¸¦åŠ å…¥å…¨åŸŸé™£åˆ—
    const id = 'i' + Date.now() + Math.floor(Math.random()*1000);
    const item = { id, code, name, color, size, price, qty, subtotal };
    window.items.push(item);

    // å°‡å®ƒæ¸²æŸ“åˆ°ç•«é¢
    renderItems();
}

/* ==========================
   æ¸²æŸ“ items åˆ° DOM
   é¡¯ç¤ºæœ€ç°¡æ½”ï¼šå“å / å–®åƒ¹ / æ•¸é‡ / å°è¨ˆï¼ˆä½ é¸ 3ï¼‰
   ========================== */
function renderItems() {
    const wrapper = document.getElementById('item-list');
    wrapper.innerHTML = '';
    if (!window.items.length) {
        document.getElementById('no-items').style.display = 'block';
        wrapper.appendChild(document.getElementById('no-items'));
        updateTotals();
        return;
    } else {
        // ç§»é™¤ no-items (å¦‚æœåœ¨)
        const ni = document.getElementById('no-items');
        if (ni) ni.style.display = 'none';
    }

    window.items.forEach(it => {
        const row = document.createElement('div');
        row.className = 'item-row dynamic-item-wrapper';
        row.dataset.id = it.id;

        // åˆªé™¤æŒ‰éˆ•
        const del = document.createElement('div');
        del.className = 'delete-btn';
        del.textContent = 'Ã—';
        del.title = 'åˆªé™¤æ­¤é …ç›®';
        del.onclick = () => {
            removeItem(it.id);
        };

        const name = document.createElement('div');
        name.className = 'name';
        name.innerHTML = `<div class="item-name">${escapeHtml(it.name)}${it.color?'<div class="meta">é¡è‰²:'+escapeHtml(it.color)+'</div>':''}${it.size?'<div class="meta">å°ºå¯¸:'+escapeHtml(it.size)+'</div>':''}</div>`;

        const price = document.createElement('div');
        price.className = 'price';
        price.contentEditable = true;
        price.innerText = formatNumber(it.price);
        price.addEventListener('input', (e) => {
            const v = parseNumber(e.target.innerText);
            it.price = isNaN(v)?0:v;
            it.subtotal = it.price * it.qty;
            renderItems(); // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°å°è¨ˆ
            updateTotals();
        });

        const qty = document.createElement('div');
        qty.className = 'qty';
        qty.contentEditable = true;
        qty.innerText = String(it.qty);
        qty.addEventListener('input', (e) => {
            const v = parseInt(e.target.innerText) || 0;
            it.qty = v;
            it.subtotal = it.price * it.qty;
            renderItems();
            updateTotals();
        });

        const subtotal = document.createElement('div');
        subtotal.className = 'subtotal';
        subtotal.innerText = formatNumber(it.subtotal);

        row.appendChild(del);
        row.appendChild(name);
        row.appendChild(price);
        row.appendChild(qty);
        row.appendChild(subtotal);

        wrapper.appendChild(row);
    });

    updateTotals();
}

/* ==========================
   ç§»é™¤ item
   ========================== */
function removeItem(id) {
    window.items = window.items.filter(i => i.id !== id);
    renderItems();
}

/* ==========================
   æ›´æ–°ç¸½è¨ˆ
   - product-total: å•†å“ç¸½é¡ï¼ˆä¸å«é‹è²»æŠ˜æ‰£ï¼‰
   - final-total: productTotal - discount + shipping
   - summary: "ç­†æ•¸ &nbsp; æ•¸é‡ç¸½å’Œ &nbsp; å•†å“ç¸½é¡"
   ä»»ä½• contenteditable çš„ discount / shipping / product-total è®Šæ›´éƒ½æœƒé‡æ–°è¨ˆç®—
   ========================== */
function updateTotals() {
    const productTotal = window.items.reduce((s,i)=>s + Number(i.price || 0) * Number(i.qty || 0), 0);
    const qtyTotal = window.items.reduce((s,i)=>s + Number(i.qty || 0), 0);
    const count = window.items.length;

    const productTotalElem = document.getElementById('product-total');
    productTotalElem.innerText = formatNumber(productTotal);

    // è®€å– discount & shippingï¼ˆå¦‚æœ user æ‰‹å‹•ä¿®æ”¹ï¼Œå…è¨±ç‚ºç©ºæˆ–éæ•¸ -> 0ï¼‰
    const discountElem = document.getElementById('discount');
    const shippingElem = document.getElementById('shipping');
    let discount = parseNumber(discountElem.innerText || discountElem.textContent) || 0;
    let shipping = parseNumber(shippingElem.innerText || shippingElem.textContent) || 0;

    // final total
    const final = Number(productTotal) - Number(discount) + Number(shipping);
    document.getElementById('final-total').innerText = formatNumber(final >= 0 ? final : 0);

    // update top summary
    document.getElementById('summary').innerHTML = `${count}ç­† &nbsp; ${qtyTotal} &nbsp; ${formatNumber(productTotal)}`;

    // top total (å·¦ä¸Šå¤§é‡‘é¡)
    document.getElementById('top-total').innerText = `TWD ${formatNumber(final >= 0 ? final : 0)}`;
}

/* ç•¶ user ä¿®æ”¹ discount / shipping / final çš„ contenteditable æ™‚è¦é‡æ–°è¨ˆç®— */
document.addEventListener('input', (e) => {
    if (!e.target) return;
    const id = e.target.id;
    if (id === 'discount' || id === 'shipping' || id === 'product-total' || id === 'final-total') {
        // å…è¨± user ä¿®æ”¹æ–‡å­—ï¼Œç¨å¾Œè§¸ç™¼æ›´æ–°
        setTimeout(updateTotals, 100);
    }
});

/* ==========================
   æˆªåœ–æ¨¡å¼åˆ‡æ›
   ========================== */
function toggleCaptureMode(btn) {
    document.body.classList.toggle("capture-mode");
    btn.textContent =
        document.body.classList.contains("capture-mode")
        ? "è§£é™¤æˆªåœ–æ¨¡å¼"
        : "åˆ‡æ›æˆªåœ–æ¨¡å¼";
}

/* ==========================
   Utilities
   ========================== */
function formatNumber(n) {
    n = Number(n) || 0;
    return n.toLocaleString('en-US',{maximumFractionDigits:2}).replace(/\.00$/,'');
}
function parseNumber(str) {
    if (typeof str !== 'string') str = String(str);
    const m = str.replace(/[^\d\.\-]/g, '');
    return m === '' ? 0 : Number(m);
}
function escapeHtml(unsafe) {
    if (!unsafe && unsafe !== 0) return '';
    return String(unsafe)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#039;");
}

/* ==========================
   åˆå§‹ renderï¼ˆè‹¥æœ‰é è¨­é …ç›®å¯æ”¾åœ¨é€™ï¼‰
   ========================== */
renderItems();
updateTotals();
</script>

</body>
</html>
