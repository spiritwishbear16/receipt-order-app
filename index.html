<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AI è‡ªå‹•è¨‚å–®æ”¶æ“šï¼ˆå®Œæ•´ç‰ˆï¼‰</title>
<style>
body{margin:0;padding:0;background:#444;display:flex;justify-content:center;min-height:100vh;font-family:'Noto Sans TC', 'Roboto Mono', monospace}
.receipt{background:#fff;width:100%;max-width:720px;padding:18px;box-sizing:border-box;color:#000}
.header{display:flex;justify-content:space-between;align-items:flex-start}
.title{font-size:22px;font-weight:700}
.row{display:flex;justify-content:space-between;align-items:center}
.store-name{text-align:center;font-size:20px;font-weight:700;margin:8px 0}
.divider{border-bottom:1px solid #222;margin:8px 0}
#item-list{margin-top:6px}
.item-row{display:flex;gap:12px;align-items:center;padding:6px 0;border-bottom:1px dashed #eee}
.item-row .name{flex:1}
.item-row .price,.item-row .qty,.item-row .subtotal{width:100px;text-align:right}
.controls{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px;z-index:999}
.btn{background:#007bff;color:#fff;padding:10px 14px;border-radius:8px;border:none;cursor:pointer}
.btn.green{background:#28a745}
.small{padding:6px 8px;font-size:13px}
.info-row{display:flex;gap:12px;align-items:center}
.select{padding:6px;border-radius:6px}
.delete-btn{cursor:pointer;color:#900;padding:2px 6px}
.capture-hide *{visibility:hidden}
</style>
</head>
<body>
<div class="receipt" id="receipt-root">
  <div class="header">
    <div>
      <div class="title">è¨‚ å–® æ”¶ æ“š <span style="font-size:12px">(å®¢æˆ¶è¯)</span></div>
      <div id="order-no" contenteditable="true">0001-æ–°é–‹</div>
    </div>
    <div class="right">
      <div id="receiver" contenteditable="true" style="font-weight:700">æ”¶ä»¶äººå§“å</div>
      <div id="current-datetime" style="font-size:12px;color:#555"></div>
    </div>
  </div>

  <div class="divider"></div>
  <div class="store-name">ç’¦åŠç«¥è£</div>
  <div class="divider"></div>

  <div class="row">
    <div style="font-weight:700">å“å</div>
    <div style="display:flex;gap:12px;width:360px;justify-content:flex-end;font-weight:700">
      <div style="width:100px;text-align:right">å–®åƒ¹</div>
      <div style="width:100px;text-align:right">æ•¸é‡</div>
      <div style="width:100px;text-align:right">å°è¨ˆ</div>
    </div>
  </div>

  <div id="item-list"></div>

  <div class="divider"></div>

  <div style="display:flex;justify-content:space-between;align-items:center">
    <div>--- éŠ·å”®å°è¨ˆ ---</div>
    <div id="summary">0ç­† 0 ä»¶</div>
  </div>

  <div class="divider"></div>

  <div style="max-width:420px;margin-left:auto">
    <div class="info-row"><div>å•†å“é‡‘é¡:</div><div id="product-total" style="margin-left:auto">0</div></div>
    <div class="info-row"><div>æŠ˜æ‰£:</div>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <select id="discount-select" class="select">
          <option value="0">ç„¡</option>
          <option value="0.3">ä¸ƒæŠ˜ï¼ˆ30% æŠ˜æ‰£ï¼‰</option>
          <option value="0.2">å…«æŠ˜ï¼ˆ20% æŠ˜æ‰£ï¼‰</option>
        </select>
        <div id="discount-amount">æŠ˜æ‰£é‡‘é¡ï¼š0</div>
      </div>
    </div>
    <div class="info-row"><div>é‹è²»:</div><div id="shipping" contenteditable="true" style="margin-left:auto">0</div></div>
    <div class="divider"></div>
    <div class="info-row" style="font-weight:700;font-size:18px"><div>æ‡‰ä»˜é‡‘é¡:</div><div id="final-total" style="margin-left:auto">0</div></div>
  </div>

</div>

<div class="controls">
  <button class="btn green small" id="ai-btn">ğŸ› ä¸€éµè²¼ä¸Šå•†å“</button>
  <button class="btn small" id="export-png">â¬‡ï¸ åŒ¯å‡º PNG</button>
  <button class="btn small" id="toggle-capture">åˆ‡æ›æˆªåœ–é¡¯ç¤º</button>
</div>

<script>
// ========== æ—¥æœŸæ™‚é–“ ===========
function updateDateTime(){
  const now=new Date();
  const y=now.getFullYear();
  const M=String(now.getMonth()+1).padStart(2,'0');
  const d=String(now.getDate()).padStart(2,'0');
  const days=['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'];
  const hh=String(now.getHours()).padStart(2,'0');
  const mm=String(now.getMinutes()).padStart(2,'0');
  document.getElementById('current-datetime').textContent = `${y}-${M}-${d}(${days[now.getDay()]}) ${hh}:${mm}`;
}
setInterval(updateDateTime,1000); updateDateTime();

// ========== å…¨åŸŸå„²å­˜ ===========
window.items = []; // {key,name,price,qty,subtotal,color,size}

// Utility
function num(v){ return Number(String(v).replace(/[^\d.-]/g,'')) || 0 }
function fmt(v){ return Number(v).toLocaleString('en-US').replace(/\.00$/,'') }

// ========== AI è²¼ä¸Šä¸¦è§£æï¼ˆå¯å¤šç­†ï¼‰ ===========
async function aiInputPrompt(){
  const txt = prompt('è«‹è²¼ä¸Šå®¢æˆ¶è¨‚å–®å…§å®¹ï¼ˆå¤šç­†ä»¥ç©ºç™½è¡Œåˆ†éš”ï¼‰ï¼š');
  if(!txt) return;
  parseTextBlocks(txt);
}

document.getElementById('ai-btn').addEventListener('click', aiInputPrompt);

function parseTextBlocks(text){
  // normalize
  const normalized = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').trim();
  // split by blank line
  const blocks = normalized.split(/\n\s*\n/).map(b=>b.trim()).filter(Boolean);

  blocks.forEach(block=>{
    const item = parseOneBlock(block);
    if(item){ mergeOrPush(item); }
  });

  // parse extras like totals, shipping, receiver
  parseExtras(normalized);
  renderItems();
  updateTotals();
}

// è§£æå–®ç­†å€å¡Š
function parseOneBlock(b){
  // name: text before first "(" or before "Code"
  const nameMatch = b.match(/^([\s\S]*?)\s*\(/);
  let name = nameMatch ? nameMatch[1].trim() : ( (b.match(/^(.*)Code/i)||[,'å•†å“'])[1].trim() );

  // color
  const color = (b.match(/é¡è‰²[\s\:\ï¼š]*[ã€\[]?(.*?)[ã€‘\]]?(?:\s|$)/i)||['','']).pop().trim();
  // size
  const size = (b.match(/å°ºå¯¸[\s\:\ï¼š]*[ã€\[]?(.*?)[ã€‘\]]?(?:\s|$)/i)||['','']).pop().trim();
  // price: try explicit TWD or åƒ¹æ ¼ or é‡‘é¡
  let price = 0;
  const p1 = b.match(/TWD\s*([0-9,\.]+)/i) || b.match(/åƒ¹æ ¼[\s\:\ï¼š]*[TWD\s]*([0-9,\.]+)/i) || b.match(/é‡‘é¡[\s\:\ï¼š]*[TWD\s]*([0-9,\.]+)/i);
  if(p1) price = num(p1[1]);
  // fallback: look for number inside parentheses like (TWD 660)
  if(!price){ const p2 = b.match(/\(.*?([0-9,]{2,}).*?\)/); if(p2) price = num(p2[1]); }

  // qty: if block repeated count will handle merge; sometimes block contains æ•¸é‡
  let qty = 1;
  const q = b.match(/æ•¸é‡[\s\:\ï¼š]*([0-9]+)/i);
  if(q) qty = num(q[1]);

  if(!name) return null;
  return {key: makeKey(name,color,size,price), name, color, size, price, qty, subtotal: price*qty};
}

function makeKey(name,color,size,price){ return `${name}||${color||''}||${size||''}||${price||0}` }

// å¦‚æœå­˜åœ¨ç›¸åŒ key å‰‡åˆä½µæ•¸é‡ï¼Œå¦å‰‡ push
function mergeOrPush(item){
  const idx = window.items.findIndex(i=>i.key===item.key);
  if(idx>=0){ window.items[idx].qty += item.qty; window.items[idx].subtotal = window.items[idx].qty * window.items[idx].price; }
  else { window.items.push(item); }
}

// è§£æå…¶ä»–è³‡è¨Šï¼ˆå•†å“ç¸½é‡‘é¡ã€é‹è²»ã€è¨‚å–®ç¸½é‡‘é¡ã€æ”¶ä»¶äººï¼‰
function parseExtras(text){
  const prod = text.match(/å•†å“ç¸½é‡‘é¡[^0-9\d]*(\d[0-9,]*)/i);
  const ship = text.match(/é‹è²»[^0-9\d]*(\d[0-9,]*)/i);
  const final = text.match(/è¨‚å–®ç¸½é‡‘é¡[^0-9\d]*(\d[0-9,]*)/i);
  const receiver = text.match(/æ”¶ä»¶äºº[:ï¼š]\s*(.+)/i);
  if(prod) document.getElementById('product-total').textContent = fmt(num(prod[1]));
  if(ship) document.getElementById('shipping').textContent = fmt(num(ship[1]));
  if(final) document.getElementById('final-total').textContent = fmt(num(final[1]));
  if(receiver) document.getElementById('receiver').textContent = receiver[1].trim();
}

// ========== é¡¯ç¤ºèˆ‡æ“ä½œ ===========
function renderItems(){
  const list = document.getElementById('item-list'); list.innerHTML='';
  if(window.items.length===0){ list.innerHTML = '<div style="text-align:center;color:#888;padding:10px">ç›®å‰å°šç„¡å•†å“</div>'; return; }

  window.items.forEach(it=>{
    const r = document.createElement('div'); r.className='item-row dynamic-item-wrapper';
    r.dataset.key = it.key;

    const name = document.createElement('div'); name.className='name'; name.innerHTML = `<div style="font-weight:600">${escapeHtml(it.name)}</div><div style="font-size:12px;color:#555">${it.color?('é¡è‰²:'+escapeHtml(it.color)):''} ${it.size?(' / å°ºå¯¸:'+escapeHtml(it.size)):''}</div>`;
    const price = document.createElement('div'); price.className='price'; price.textContent = fmt(it.price);
    const qty = document.createElement('div'); qty.className='qty'; qty.contentEditable = true; qty.textContent = it.qty;
    const subtotal = document.createElement('div'); subtotal.className='subtotal'; subtotal.textContent = fmt(it.subtotal);
    const del = document.createElement('div'); del.className='delete-btn'; del.textContent='åˆªé™¤'; del.onclick = ()=>{ window.items = window.items.filter(x=>x.key!==it.key); renderItems(); updateTotals(); };

    // ç•¶ä½¿ç”¨è€…ä¿®æ”¹æ•¸é‡æ™‚
    qty.addEventListener('input', e=>{
      const v = num(e.target.textContent) || 0;
      it.qty = v; it.subtotal = it.price * it.qty;
      renderItems(); updateTotals();
    });

    r.appendChild(del); r.appendChild(name); r.appendChild(price); r.appendChild(qty); r.appendChild(subtotal);
    list.appendChild(r);
  });
}

function updateTotals(){
  const productTotal = window.items.reduce((s,i)=>s + (i.price * i.qty), 0);
  document.getElementById('product-total').textContent = fmt(productTotal);

  // discount select
  const sel = document.getElementById('discount-select');
  const rate = Number(sel.value) || 0; // 0.3 means 30% off (ä¸ƒæŠ˜)
  const discountAmount = Math.round(productTotal * rate);
  document.getElementById('discount-amount').textContent = 'æŠ˜æ‰£é‡‘é¡ï¼š' + fmt(discountAmount);

  const ship = num(document.getElementById('shipping').textContent);
  const final = productTotal - discountAmount + (ship||0);
  document.getElementById('final-total').textContent = fmt(final>=0?final:0);

  document.getElementById('summary').textContent = `${window.items.length}ç­† ${window.items.reduce((s,i)=>s+i.qty,0)} ä»¶`;
}

// ç•¶ user ä¿®æ”¹ shipping æˆ– discount é¸æ“‡
document.getElementById('discount-select').addEventListener('change', updateTotals);
document.getElementById('shipping').addEventListener('input', ()=>{ updateTotals(); });

// ========== åŒ¯å‡ºç‚º PNGï¼ˆä½¿ç”¨ SVG foreignObject æ–¹æ³•ï¼‰ ===========
async function exportPNG(){
  const el = document.getElementById('receipt-root');
  // å„²å­˜ç›®å‰é«˜åº¦èˆ‡å¯¬åº¦
  const rect = el.getBoundingClientRect();
  const width = Math.ceil(rect.width);
  const height = Math.ceil(rect.height);

  // clone and inline styles
  const clone = el.cloneNode(true);
  // remove controls from clone if any
  clone.querySelectorAll('.delete-btn').forEach(n=>n.remove());

  const serialized = new XMLSerializer().serializeToString(clone);
  const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='${width}' height='${height}'><foreignObject width='100%' height='100%'>${serialized}</foreignObject></svg>`;
  const blob = new Blob([svg],{type:'image/svg+xml;charset=utf-8'});
  const url = URL.createObjectURL(blob);

  const img = new Image();
  img.onload = ()=>{
    const canvas = document.createElement('canvas'); canvas.width = width; canvas.height = height;
    const ctx = canvas.getContext('2d');
    // ç™½åº•
    ctx.fillStyle = '#ffffff'; ctx.fillRect(0,0,width,height);
    ctx.drawImage(img,0,0);
    URL.revokeObjectURL(url);
    canvas.toBlob(function(blob2){
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob2); a.download = 'receipt.png'; document.body.appendChild(a); a.click(); a.remove();
    });
  };
  img.onerror = ()=>{ alert('åŒ¯å‡º PNG å¤±æ•—ï¼ˆç€è¦½å™¨å¯èƒ½é™åˆ¶ foreignObject è½‰æ›ï¼‰ã€‚å»ºè­°æ”¹ç”¨æˆªåœ–å·¥å…·æˆ–ä½¿ç”¨ Chrome/Firefoxã€‚'); URL.revokeObjectURL(url); };
  img.src = url;
}

document.getElementById('export-png').addEventListener('click', exportPNG);

document.getElementById('toggle-capture').addEventListener('click', ()=>{
  document.body.classList.toggle('capture-hide');
});

// escape
function escapeHtml(s){ if(!s && s!==0) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// init
renderItems(); updateTotals();
</script>
</body>
</html>
